<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>笑脸艺术 Lite：空出 NARISA</title>
  <style>
    body {
      margin: 0;
      background: #0b0f14;
      font-family: sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header, footer {
      padding: 10px;
      text-align: center;
    }
    #stage {
      flex: 1;
      position: relative;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    .controls {
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <header>
    <h1>笑脸艺术 Lite · <span>NARISA</span></h1>
    <div class="controls">
      密度 <input id="density" type="range" min="18" max="60" value="34" />
      字号 <input id="fontSize" type="range" min="14" max="48" value="26" />
      <input id="textInput" value="NARISA" maxlength="16" />
      <button id="shuffle">换个排布</button>
      <button id="save">保存 PNG</button>
    </div>
  </header>

  <div id="stage">
    <canvas id="art"></canvas>
  </div>

  <footer>
    本地 PNG 轻量版，不依赖外部字体/Emoji 库
  </footer>

  <script>
    const canvas = document.getElementById('art');
    const ctx = canvas.getContext('2d');
    const densityEl = document.getElementById('density');
    const fontSizeEl = document.getElementById('fontSize');
    const inputEl = document.getElementById('textInput');
    const shuffleBtn = document.getElementById('shuffle');
    const saveBtn = document.getElementById('save');

    let seed = Math.random() * 1e9;
    const emojiFiles = ["smile1.png","smile2.png","smile3.png","smile4.png","smile5.png","smile6.png"];
    const emojis = [];
    let loaded = 0;

    function rand() {
      seed = (1664525 * seed + 1013904223) % 4294967296;
      return seed / 4294967296;
    }

    function resize() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = canvas.clientWidth * dpr;
      canvas.height = canvas.clientHeight * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      draw();
    }

    function draw() {
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "#0b0f14";
      ctx.fillRect(0, 0, w, h);

      const step = parseInt(densityEl.value, 10);
      const size = parseInt(fontSizeEl.value, 10);

      for (let y = step; y < h; y += step) {
        for (let x = step; x < w; x += step) {
          const jx = (rand() - 0.5) * step * 0.2;
          const jy = (rand() - 0.5) * step * 0.2;
          const img = emojis[Math.floor(rand() * emojis.length)];
          ctx.globalAlpha = 0.75 + rand() * 0.25;
          ctx.drawImage(img, x + jx - size/2, y + jy - size/2, size, size);
        }
      }
      ctx.globalAlpha = 1;

      const text = (inputEl.value || "NARISA").toUpperCase();
      ctx.save();
      ctx.globalCompositeOperation = "destination-out";
      ctx.font = `900 ${Math.min(w*0.25,h*0.28)}px sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(text, w/2, h/2);
      ctx.restore();
    }

    function savePNG() {
      const link = document.createElement('a');
      link.download = `${(inputEl.value || 'NARISA')}-smiley-art.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    window.addEventListener('resize', resize);
    densityEl.addEventListener('input', draw);
    fontSizeEl.addEventListener('input', draw);
    inputEl.addEventListener('input', draw);
    shuffleBtn.addEventListener('click', () => { seed = Math.random() * 1e9; draw(); });
    saveBtn.addEventListener('click', savePNG);

    // 加载 PNG
    emojiFiles.forEach(file => {
      const img = new Image();
      img.src = "emoji/" + file;
      img.onload = () => {
        loaded++;
        if (loaded === emojiFiles.length) {
          emojis.push(...emojiFiles.map(f => {
            const i = new Image();
            i.src = "emoji/" + f;
            return i;
          }));
          resize();
        }
      };
    });
  </script>
</body>
</html>
